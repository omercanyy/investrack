rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Users can read and create their own user document. They can also update it.
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // Users can manage their own positions, closed_positions, and strategies.
    match /users/{userId}/{collection}/{docId} {
      allow read, write, delete: if request.auth != null && request.auth.uid == userId;
    }

    // The 'betas' collection is a cache. Authenticated users can read from it.
    // Writes should be handled by a secure backend process.
    match /betas/{ticker} {
      allow read: if request.auth != null;
      allow write: if false; // Disallow client-side writes
    }

    // User credentials should ONLY be accessible by backend functions.
    // Deny all client-side access.
    match /brokerage_integration_tokens/{userId} {
      allow read, write: if false;
    }
  }
}
